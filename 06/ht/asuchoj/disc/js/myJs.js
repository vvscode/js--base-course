"use strict";function _toConsumableArray(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}var searchButton=document.querySelector("#search_button"),searchEnter=document.querySelector("#search_enter"),addInFavorites=document.querySelector("#add_to_favorites"),historyCity=document.querySelector(".history_city"),favoritesCity=document.querySelector(".favorites_city"),request=document.getElementsByName("request_type"),menu=document.querySelector("menu"),newEventBus=new EventBus,arrCity=[],arrWithFavoritesCity=[],hashForCityPage="#city/",xhrOrFetchValue=void 0,cityName=void 0,latCity=void 0,lngCity=void 0;if([].forEach.call(request,function(t){t.getAttribute("checked")||(xhrOrFetchValue=t.value),t.addEventListener("change",function(){xhrOrFetchValue=t.value})}),localStorage.hasOwnProperty("historyCity")&&getHistoryCity().then(function(t){return arrCity=t}).then(function(){return addArr(arrCity,historyCity,addElemWithCityInHTML)}).catch(console.log),localStorage.hasOwnProperty("favoritesCity")&&getFavoritesCity().then(function(t){return arrWithFavoritesCity=t}).then(function(){return addArr(arrWithFavoritesCity,favoritesCity,addElemWithSpaceInHTML)}).catch(console.log),newEventBus.on("init",function(){cityName=(cityName=location.hash.split("/")[1]).split(","),latCity=cityName[0],lngCity=cityName[1],parseInt(cityName)?(newEventBus.on("прогрузилась_карта",function(){return newEventBus.trigger("показать_центер_карты",latCity,lngCity)}),newEventBus.trigger("показать_центер_карты",latCity,lngCity),newEventBus.trigger("Запросить_погоду_для_города",xhrOrFetchValue,latCity,lngCity)):newEventBus.trigger("Дать_данные",xhrOrFetchValue,cityName)}),newEventBus.on("main",function(){return newEventBus.trigger("Местоположение",xhrOrFetchValue)}),newEventBus.on("Дать_координаты_с_гугла",function(t,e){latCity=t,lngCity=e,newEventBus.trigger("показать_центер_карты",t,e)}),newEventBus.on("Координаты_Местоположения",function(t,e){latCity=t,lngCity=e,newEventBus.trigger("показать_центер_карты",t,e)}),""!==location.hash&&"#main"!==location.hash&&"#about"!==location.hash&&"#author"!==location.hash&&"#"!==location.hash){var _cityName=location.hash.split("/")[1];_cityName=_cityName.split(","),latCity=_cityName[0],lngCity=_cityName[1],parseInt(_cityName)||newEventBus.on("прогрузилась_карта",function(){newEventBus.trigger("показать_центер_карты",latCity,lngCity)})}else"#main"===location.hash&&newEventBus.trigger("Местоположение",xhrOrFetchValue);function addSpaceInFavorite(t){addArrCity([addRoundNumber(t[0],1e3),addRoundNumber(t[1],1e3)],arrWithFavoritesCity),addArr(arrWithFavoritesCity,favoritesCity,addElemWithSpaceInHTML),storeFavoritesCity()}function addRoundNumber(t,e){return Math.round(t*e)/e}function addArrCity(t,e){return 0===e.length?e.unshift(t):(e.forEach(function(n,r){n.toString()===t.toString()&&e.splice(r,1)}),e.length<5?e.unshift(t):e.length>=5&&(e.pop(),e.unshift(t)),e)}function addElemWithCityInHTML(t){return"<p>"+t+"</p>"}function addArr(t,e,n){e.innerHTML="",t.forEach(function(t){e.innerHTML=e.innerHTML+n(t)})}function addElemWithSpaceInHTML(t){return"<div> <p>"+t+"</p><button> x </button></div>"}function testEnterValue(t){return""===t?prompt("Введите наименование города","Минск"):t}function saveHistoryCityInLocal(){var t=JSON.stringify(arrCity);return Promise.resolve(localStorage.setItem("historyCity",t))}function getHistoryCity(){return Promise.resolve(JSON.parse(localStorage.getItem("historyCity")))}function storeFavoritesCity(){var t=JSON.stringify(arrWithFavoritesCity);return Promise.resolve(localStorage.setItem("favoritesCity",t))}function getFavoritesCity(){return Promise.resolve(JSON.parse(localStorage.getItem("favoritesCity")))}function EventBus(){this.listeners={}}newEventBus.on("Погода_получена",function(t){return newEventBus.trigger("Отрисовать_погоду",t)}),newEventBus.on("getCentralYandexMap",function(t){return addSpaceInFavorite(t)}),menu.addEventListener("click",function(t){var e=t.target;"A"===e.tagName&&"Main"===e.innerHTML&&newEventBus.trigger("main")}),searchButton.addEventListener("click",function(t){t.preventDefault();var e=testEnterValue(searchEnter.value);addArrCity(e=e.charAt(0).toUpperCase()+e.substr(1).toLowerCase(),arrCity),addArr(arrCity,historyCity,addElemWithCityInHTML),location.hash=hashForCityPage+e,saveHistoryCityInLocal()}),addInFavorites.addEventListener("click",function(){return newEventBus.trigger("addInFavorites")}),favoritesCity.addEventListener("click",function(t){var e=t.target;if("P"===e.tagName&&(location.hash=hashForCityPage+e.innerHTML),"BUTTON"===e.tagName){favoritesCity.removeChild(e.parentNode);var n=e.parentNode.querySelector("p").innerHTML;addArrCity(n,arrWithFavoritesCity),arrWithFavoritesCity.forEach(function(t,e){if(t+""==n+"")return arrWithFavoritesCity.splice(e,1)}),storeFavoritesCity()}}),historyCity.addEventListener("click",function(t){var e=t.target;"P"===e.tagName&&(location.hash=hashForCityPage+e.innerHTML)}),EventBus.prototype.on=function(t,e){this.listeners[t]=Array.isArray(this.listeners[t])?this.listeners[t]:[],this.listeners[t].push(e)},EventBus.prototype.off=function(t,e){var n=this;if(!t&&e){var r=function(t){n.listeners.hasOwnProperty(t)&&n.listeners[t].forEach(function(r){var i=[];return r!==e&&i.push(r),n.listeners[t]=i})};for(var i in this.listeners)r(i)}if(t&&!e)for(var i in this.listeners)this.listeners.hasOwnProperty(i)&&this.listeners[i]===this.listeners[t]&&(this.listeners[t]=void 0);if(t&&e){var o=[];if(void 0===e)return;return this.listeners[t].forEach(function(t){t!==e&&o.push(t)}),this.listeners[t]=o}if(!t&&!e)return this.listeners={}},EventBus.prototype.trigger=function(t){for(var e=this,n=arguments.length,r=Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];(this.listeners[t]||[]).forEach(function(t){return t.apply(e,r)})},EventBus.prototype.once=function(t,e){var n=this;this.on(t,function r(){e.apply(this,arguments),n.off(t,r)})};var Router=function(t){this.routes=t.routes||[],this.eventBus=t.eventBus,this.init()};Router.prototype={init:function(){var t=this;window.addEventListener("hashchange",function(){return t.handleUrl(window.location.hash)}),this.handleUrl(window.location.hash)},findPreviousActiveRoute:function(){return this.currentRoute},findNewActiveRoute:function(t){return this.routes.find(function(e){return"string"==typeof e.match?t===e.match:"function"==typeof e.match?e.match(t):e.match instanceof RegExp?t.match(e.match):void 0})},getRouteParams:function(t,e){var n=e.match(t.match)||[];return n.shift(),n},handleUrl:function(t){var e=this;t=t.slice(1);var n=this.findPreviousActiveRoute(),r=this.findNewActiveRoute(t),i=this.getRouteParams(r,t);Promise.resolve().then(function(){return n&&n.onLeave&&n.onLeave.apply(n,_toConsumableArray(e.currentRouteParams))}).then(function(){return r&&r.onBeforeEnter&&r.onBeforeEnter.apply(r,_toConsumableArray(i))}).then(function(){return r&&r.onEnter&&r.onEnter.apply(r,_toConsumableArray(i))}).then(function(){e.currentRoute=r,e.currentRouteParams=i})}};var router=new Router({routes:[{name:"index",match:""},{name:"city",match:/city(.+)/,onEnter:function(){newEventBus.trigger("init"),addClassInShowPage()}},{name:"string",match:function(t){return t},onBeforeEnter:function(){return delClassInPages()},onEnter:function(){addClassInShowPage(),"#main"===location.hash&&newEventBus.trigger("main")},onLeave:function(){return delClassInPages()}}]});function addClassInShowPage(){var t=location.hash.split("#").join("");("about"===t||"author"===t||"main"===t?document.querySelector("."+location.hash.split("#")[1]):document.querySelector(".main")).classList.add("page_show")}function delClassInPages(){var t=document.querySelectorAll(".page");[].forEach.call(t,function(t){t.classList.remove("page_show")})}!function(){var t="0ab145c90c84d13965489477a486e847",e="https://api.userinfo.io/userinfos",n=new XMLHttpRequest;function r(t,e,n){return"XHR"===t?e:"Fetch"===t?n:void 0}function i(e,n){return"https://cors-anywhere.herokuapp.com/https://api.darksky.net/forecast/"+t+"/"+e+","+n+"?lang=ru&units=si"}function o(t){return"https://maps.googleapis.com/maps/api/geocode/json?address="+t+"&sensor=false&language=ru"}function a(){n.open("GET",e,!0),n.send(),n.onreadystatechange=function(){if(4===n.readyState)if(200!==n.status)alert(n.status+": "+n.statusText);else{var t=JSON.parse(n.responseText),e=t.position.latitude,r=t.position.longitude;newEventBus.trigger("Координаты_Местоположения",e,r)}}}function s(){fetch(e).then(function(t){return t.json()}).then(function(t){var e=t.position.latitude,n=t.position.longitude;newEventBus.trigger("Координаты_Местоположения",e,n)}).catch(alert)}function u(t){n.open("GET",o(t),!0),n.send(),n.onreadystatechange=function(){if(4===n.readyState)if(200!==n.status)alert(n.status+": "+n.statusText);else{var t=JSON.parse(n.responseText),e=t.results[0].geometry.location.lat,r=t.results[0].geometry.location.lng;newEventBus.trigger("Дать_координаты_с_гугла",e,r)}}}function c(t){fetch(o(t)).then(function(t){return t.json()}).then(function(t){var e=t.results[0].geometry.location.lat,n=t.results[0].geometry.location.lng;newEventBus.trigger("Дать_координаты_с_гугла",e,n)}).catch(alert)}function h(t,e){n.open("GET",i(t,e),!0),n.send(),n.onreadystatechange=function(){if(4===n.readyState)if(200!==n.status)alert(n.status+": "+n.statusText);else{var t=JSON.parse(n.responseText);newEventBus.trigger("Погода_получена",t.currently)}}}function l(t,e){fetch(i(t,e)).then(function(t){return t.json()}).then(function(t){newEventBus.trigger("Погода_получена",t.currently)}).catch(alert)}newEventBus.on("Дать_данные",function(t,e){r(t,u,c)(e)}),newEventBus.on("Запросить_погоду_для_города",function(t,e,n){r(t,h,l)(e,n)}),newEventBus.on("Местоположение",function(t){r(t,a,s)()})}(),function(){var t=void 0;function e(t){return Math.round(t)}ymaps.ready(function(){t=new ymaps.Map("map",{center:[53.905,27.562],zoom:11,controls:["zoomControl","typeSelector"]}),newEventBus.on("показать_центер_карты",function(e,n){var r,i;r=e,i=n,t.setCenter([r,i])}),newEventBus.on("addInFavorites",function(){newEventBus.trigger("getCentralYandexMap",t.getCenter())}),newEventBus.trigger("прогрузилась_карта"),t.events.add("actionend",function(){t.getCenter(),location.hash="#city/"+t.getCenter()}),t.events.add("dblclick",function(t){newEventBus.trigger("getCentralYandexMap",t.get("coords"))})}),newEventBus.on("Отрисовать_погоду",function(t){var n,r,i,o,a,s,u,c;n=t,r="<p> Температура: "+e(Math.round(n.apparentTemperature))+" &#8451 </p>",i="<p> Давление: "+e(n.pressure)+" гПа </p>",o="<p> Влажность: "+e(100*n.humidity)+" % </p>",a="<p> Скорость ветра: "+e(n.windSpeed)+" м/с </p>",s="<p> Вероятность осадков: "+n.precipProbability+"</p>",u="<p> Облачность: "+n.cloudCover+"</p>",c="<p> Сводка: "+n.summary+"</p>",document.querySelector(".weather").innerHTML=c+r+i+o+a+s+u})}();